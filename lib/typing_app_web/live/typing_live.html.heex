<div class="game-container" phx-hook="SoundSystem" id="sound-system">
  <!-- Sound Controls -->
  <div class="sound-controls">
    <button class="sound-btn" phx-click="toggle_sound">
      <%= if @sound_enabled, do: "ğŸ”Š", else: "ğŸ”‡" %>
    </button>
  </div>

  <div class="header">
    <h1 class="title">ğŸ® TypeMaster Kids ğŸ®</h1>
  </div>

  <%= if @game_state == :waiting do %>
    <div class="level-info">
      <div>
        <strong>Level: <%= @current_level %></strong>
        <div><%= level_description(@current_level) %></div>
      </div>
      <div>
        <strong>Score: <%= @score %></strong>
        <div>Total: <%= @progress.total_score %></div>
      </div>
      <div>
        <strong>Best WPM: <%= Float.round(@progress.best_wpm, 1) %></strong>
        <div>Keep improving!</div>
      </div>
    </div>

    <div class="text-display">
      Ready to start level <%= @current_level %>? Click the button below!
    </div>


    <div class="controls">
      <button class="btn btn-primary" phx-click="start_game" phx-key-action="start_game" phx-hook="AutoFocusButton" autofocus id="start-button">ğŸš€ Start Level <%= @current_level %></button>
      <button class="btn btn-warning" phx-click="reset_game">ğŸ”„ Reset Progress</button>
    </div>

  <% else %>
    <!-- Game playing interface with all the existing content -->
    <div class="level-info">
      <div>
        <strong>Level: <%= @current_level %></strong>
        <div><%= level_description(@current_level) %></div>
      </div>
      <div>
        <strong>Score: <%= @score %></strong>
        <div>Keep typing!</div>
      </div>
      <div>
        <strong>Lives: <%= String.duplicate("ğŸ’šï¸", @lives) %></strong>
        <div><%= lives_message(@lives) %></div>
      </div>
    </div>

    <div class="progress-bar">
      <div class="progress-fill" style={"width: #{progress_percentage(@current_index, @current_text)}%"}></div>
    </div>

    <div class="text-display">
      <div class="typing-progress">
        <div class="progress-percentage">
          <%= progress_percentage(@current_index, @current_text) %>% Complete
        </div>
      </div>
      <div class="text-content">
        <%= for {char, index} <- String.graphemes(@current_text) |> Enum.with_index() do %>
          <span class={"char #{char_class(index, @current_index, @typed_text, @current_text)}"}>
            <%= if char == " ", do: raw("&nbsp;"), else: char %>
          </span>
        <% end %>
      </div>
    </div>
  <% end %>

  <!-- Hidden data for JavaScript sound system -->
  <div id="sound-data"
       data-sound-enabled={to_string(@sound_enabled)}
       data-typing-sound-enabled={to_string(@typing_sound_enabled)}
       data-background-music-enabled={to_string(@background_music_enabled)}
       data-last-sound-event={@last_sound_event}
       data-current-index={@current_index}
       data-key-pressed={@current_index > 0 && String.at(@current_text, @current_index-1) == String.at(@typed_text, @current_index-1)}
       style="display: none;">
  </div>

  <!-- Hidden element for game state detection -->
  <div class="game-state" data-state={@game_state} style="display: none;">
  </div>

  <%= if @game_state == :playing do %>
      <div class="input-area">
        <input
          type="text"
          class="typing-input"
          value={@typed_text}
          phx-keyup="key_typed"
          phx-update="ignore"
          phx-hook="TypeFocusSync"
          placeholder="Start typing here..."
          autocomplete="off"
          spellcheck="false"
          autofocus
          id="typing-input"
        />
      </div>
    <% end %>

    <div class="stats">
      <div class="stat">
        <div class="stat-value"><%= Float.round(@wpm, 1) %></div>
        <div class="stat-label">Words/Min</div>
      </div>
      <div class="stat">
        <div class="stat-value"><%= Float.round(@accuracy, 1) %>%</div>
        <div class="stat-label">Accuracy</div>
      </div>
      <div class="stat">
        <div class="stat-value"><%= @time_left %></div>
        <div class="stat-label">Time Left</div>
      </div>
      <div class="stat">
        <div class="stat-value"><%= @streak %></div>
        <div class="stat-label">Streak</div>
      </div>
    </div>

    <%= if @game_state == :playing do %>
      <% 
        texts_required = cond do
          @current_level <= 5 -> 2
          @current_level <= 10 -> 3
          @current_level <= 15 -> 4
          true -> 5
        end 
      %>
      
      <div class="progress-info" style="margin-top: 10px; text-align: center; color: #4a5568; background-color: #e2e8f0; padding: 8px; border-radius: 10px;">
        <div class="progress-label">
          <strong>Level Progress:</strong> <%= @texts_completed %> of <%= texts_required %> texts completed
        </div>
      </div>
    <% end %>

    <%= if @game_state == :level_complete do %>
      <div class="game-complete">
        <h2>ğŸ‰ Level <%= @current_level %> Complete! ğŸ‰</h2>
        <p class="emoji">ğŸŒŸâ­ğŸŒŸâ­ğŸŒŸ</p>
        <p>Final Score: <%= @score %></p>
        <p>WPM: <%= Float.round(@wpm, 1) %> | Accuracy: <%= Float.round(@accuracy, 1) %>%</p>

        <!-- Guest user sign-up prompt -->
        <%= unless @current_scope && @current_scope.user do %>
          <div class="guest-prompt" style="margin: 15px 0; padding: 15px; background: rgba(255,255,255,0.2); border-radius: 10px; border: 2px dashed #fff;">
            <h3>Playing as Guest</h3>
            <p>Your progress won't be saved. Sign up to:</p>
            <ul style="text-align: left; display: inline-block;">
              <li>Save your progress</li>
              <li>Track your improvement</li>
              <li>Compete on leaderboards</li>
            </ul>
            <div>
              <a href="/users/register" class="btn btn-secondary">Sign Up</a>
              <a href="/users/log-in" class="btn btn-secondary">Log In</a>
            </div>
          </div>
        <% end %>

        <div class="controls" style="margin-top: 20px;">
          <%= if @game_state == :level_complete do %>
            <%= if @current_level < 20 do %>
              <button class="btn btn-primary" phx-click="next_level" autofocus phx-hook="AutoFocusButton" id="next-level-button" data-key-action="next_level">â¬†ï¸ Next Level</button>
            <% else %>
              <div>ğŸ† Congratulations! You've mastered all levels! ğŸ†</div>
              <button class="btn btn-primary" phx-click="reset_game" autofocus phx-hook="AutoFocusButton" id="try-again-button" data-key-action="reset_game">ğŸ”„ Play Again</button>
            <% end %>
          <% end %>
        </div>
      </div>
    <% end %>

    <%= if @game_state == :game_over do %>
      <div class="game-over">
        <h2>ğŸ’ª Keep Practicing! ğŸ’ª</h2>
        <p>Don't worry - every expert was once a beginner!</p>
        <button
          class="btn btn-primary"
          phx-click="start_game"
          autofocus
          phx-hook="AutoFocusButton"
          id="try-again-button"
          data-key-action="start_game"
        >ğŸ”„ Try Again</button>
        <button class="btn btn-secondary" phx-click="reset_game">ğŸ  Back to Level 1</button>
        <p class="help-text">Press <kbd>Enter</kbd> to try again</p>
      </div>
    <% end %>

    <!-- Text Source Selector - Always visible at the bottom -->
    <div class="text-source-selector fixed-bottom">
      <div class="source-label">Select Text Source:</div>
      <div class="source-buttons">
        <%= for {source_key, source_name} <- @text_sources do %>
          <button
            type="button"
            phx-click="select_text_source"
            phx-value-source={source_key}
            class={"source-btn #{if @selected_source == source_key, do: 'selected'}"}
          >
            <%= source_name %>
          </button>
        <% end %>
      </div>
      <div class="source-info">
        <%= case @selected_source do %>
          <% :zenquotes -> %>
            Using <a href="https://zenquotes.io/" target="_blank">ZenQuotes API</a> - inspirational quotes
          <% :dummyjson -> %>
            Using <a href="https://dummyjson.com/docs/quotes" target="_blank">DummyJSON API</a> - sample quotes
          <% _ -> %>
            Using built-in text samples for each level
        <% end %>
      </div>
    </div>
</div>

<!-- SoundSystem hook now imported from external file -->
<!-- Remaining SoundSystem hook code now imported from external file -->

<!-- Auto-focus Hooks -->
<!-- AutoFocus hook now imported from external file -->

<!-- TypeFocusSync hook now imported from external file -->

<!-- AutoFocusButton hook now imported from external file -->

<!-- CSS styles now imported from external file assets/css/typing.css -->
